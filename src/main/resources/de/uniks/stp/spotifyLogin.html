<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Web API Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script> var redirect_uri = "http://localhost:8888/callback/"; // change this your value

    const client_id = "f2557b7362074d3b93537b2803ef48b1";
    const client_secret = "85a01971a347473b907d1ae06d8fad97"; // In a real app you should not expose your client_secret to the user

    var responseUrl;

    var access_token = null;
    var refresh_token = null;

    const AUTHORIZE = "https://accounts.spotify.com/authorize"
    const TOKEN = "https://accounts.spotify.com/api/token";


    function requestAuthorization() {

        localStorage.setItem("client_id", client_id);
        localStorage.setItem("client_secret", client_secret); // In a real app you should not expose your client_secret to the user

        let url = AUTHORIZE;
        url += "?client_id=" + client_id;
        url += "&response_type=code";
        url += "&redirect_uri=" + encodeURI(redirect_uri);
        url += "&show_dialog=true";
        url += "&scope=user-read-private user-read-email user-modify-playback-state user-read-playback-position user-library-read streaming user-read-playback-state user-read-recently-played playlist-read-private";
        console.log(url);
        window.location = url; // Show Spotify's authorization screen
    }

    function handleRedirect() {
        if (window.location.href.indexOf("code=") > -1) {
            console.log("enthÃ¤lt")
            let code = getCode();
            console.log(code)
            fetchAccessToken(code);
        }
    }

    function getCode() {
        let code = null;
        const queryString = window.location.search;
        if (queryString.length > 0) {
            const urlParams = new URLSearchParams(queryString);
            code = urlParams.get('code')
        }
        return code;
    }

    function fetchAccessToken(code) {
        let body = "grant_type=authorization_code";
        body += "&code=" + code;
        body += "&redirect_uri=" + encodeURI(redirect_uri);
        body += "&client_id=" + client_id;
        body += "&client_secret=" + client_secret;
        callAuthorizationApi(body);
    }

    function callAuthorizationApi(body) {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (this.readyState === this.DONE) {
                var data = JSON.parse(this.responseText);
                console.log("Data ", data);
                responseUrl = this.responseText;
                console.log("Response Url ", responseUrl);
                window.location.href = responseUrl
                console.log("Location ", window.location.href);
            }
        }
        xhr.open("POST", TOKEN);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('Authorization', 'Basic ' + btoa(client_id + ":" + client_secret));
        xhr.send(body);
        console.log("xhr send")

    }

    </script>
</head>

<body onload="handleRedirect()">
<div class="container">

    <div id="tokenSection" class="row">
        <div class="col">
            <div style="text-align: center;">
                <h1>Connect your Spotify Account</h1>
                <input class="btn btn-primary btn-lg" type="button" onclick="requestAuthorization()"
                       value="Login to Spotify"><br/>
            </div>
        </div>
    </div>
</div>


</body>

</html>